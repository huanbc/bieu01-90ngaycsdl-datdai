<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªó Tr·ª£ Nh·∫≠p Li·ªáu Bi·ªÉu 01 - Chi·∫øn D·ªãch 90 Ng√†y ƒê√™m</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* ƒê·∫£m b·∫£o b·∫£ng hi·ªÉn th·ªã ƒë√∫ng trong khung */
        .min-w-full {
            min-width: 100%;
        }
        /* Style cho input ch·ªânh s·ª≠a */
        .data-input {
            transition: all 0.15s;
            background-color: #ffffff; /* N·ªÅn tr·∫Øng cho input ƒë·ªÉ d·ªÖ ch·ªânh s·ª≠a */
        }
        /* Style cho n√∫t ti·∫øp t·ª•c */
        .btn-continue {
            background-color: #f59e0b;
            color: white;
            transition: background-color 0.15s;
        }
        .btn-continue:hover {
            background-color: #d97706;
        }
        /* Style cho footer */
        .app-footer {
            margin-top: 3rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            font-size: 0.875rem;
            color: #6b7280;
        }
    </style>

    <script>
        // --- CH·∫∂N XEM M√É NGU·ªíN (BEST EFFORT) ---
        
        // Ch·∫∑n click chu·ªôt ph·∫£i (ngƒÉn m·ªü menu ng·ªØ c·∫£nh ch·ª©a "Xem m√£ ngu·ªìn")
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            console.warn("M√£ ngu·ªìn ·ª©ng d·ª•ng n√†y ƒë∆∞·ª£c b·∫£o v·ªá. Vui l√≤ng kh√¥ng sao ch√©p ho·∫∑c ph√¢n ph·ªëi.");
        });

        // Ch·∫∑n c√°c ph√≠m t·∫Øt F12, Ctrl+Shift+I/J, Ctrl+U
        document.addEventListener('keydown', (e) => {
            // F12
            if (e.key === 'F12') {
                e.preventDefault();
                console.warn("M√£ ngu·ªìn ·ª©ng d·ª•ng n√†y ƒë∆∞·ª£c b·∫£o v·ªá. Vui l√≤ng kh√¥ng sao ch√©p ho·∫∑c ph√¢n ph·ªëi.");
            }
            // Ctrl+Shift+I/J (Developer Tools)
            if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) {
                e.preventDefault();
                console.warn("M√£ ngu·ªìn ·ª©ng d·ª•ng n√†y ƒë∆∞·ª£c b·∫£o v·ªá. Vui l√≤ng kh√¥ng sao ch√©p ho·∫∑c ph√¢n ph·ªëi.");
            }
            // Ctrl+U (View Source)
            if (e.ctrlKey && e.key === 'U') {
                e.preventDefault();
                console.warn("M√£ ngu·ªìn ·ª©ng d·ª•ng n√†y ƒë∆∞·ª£c b·∫£o v·ªá. Vui l√≤ng kh√¥ng sao ch√©p ho·∫∑c ph√¢n ph·ªëi.");
            }
        });
        // --- K·∫æT TH√öC CH·∫∂N XEM M√É NGU·ªíN ---
    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">H·ªó Tr·ª£ Nh·∫≠p Li·ªáu Bi·ªÉu M·∫´u 01 - Chi·∫øn D·ªãch 90 Ng√†y ƒê√™m</h1>
        <p class="text-center text-gray-500 mb-8">Quy tr√¨nh 2 b∆∞·ªõc: Qu√©t CCCD v√† GCN. D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông t√≠ch l≈©y v√†o danh s√°ch v√† cho ph√©p xu·∫•t file Excel t·ªïng h·ª£p.</p>
        
        <div class="mb-6 p-4 border-2 border-dashed border-indigo-200 rounded-lg text-center">
            <label for="imageUpload" class="block text-lg font-medium text-gray-700 mb-3">1. T·∫£i ·∫¢nh T√†i Li·ªáu L√™n</label>
            <input type="file" id="imageUpload" accept="image/*, .pdf" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition duration-150">
            <img id="imagePreview" class="mt-4 mx-auto max-h-64 object-contain rounded-lg shadow-md" style="display:none;" alt="·∫¢nh xem tr∆∞·ªõc">
            <p id="uploadHint" class="mt-2 text-sm text-gray-500 italic">
                </p>
        </div>

        <div class="mb-6 p-4 border border-gray-200 rounded-lg">
            <h2 class="text-lg font-semibold text-gray-700 mb-3 flex justify-between items-center">
                Tr·∫°ng Th√°i Quy Tr√¨nh
                <span id="recordCount" class="text-sm font-normal text-indigo-600">ƒê√£ nh·∫≠p: 0 h·ªì s∆°</span>
            </h2>
            <div id="statusCccd" class="text-gray-900 mb-2">B∆∞·ªõc 1: Qu√©t CCCD/CMND - <span class="text-red-500 font-medium">Ch∆∞a ho√†n th√†nh</span></div>
            <div id="statusGcn" class="text-gray-400">B∆∞·ªõc 2: Qu√©t GCN QSDƒê - <span class="text-red-500 font-medium">Ch∆∞a ho√†n th√†nh</span></div>
        </div>

        <button id="processButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-150 disabled:opacity-50" disabled>
            2. (B∆∞·ªõc 1) B·∫Øt ƒë·∫ßu Qu√©t CCCD/CMND
        </button>
        
        <div id="loadingIndicator" class="mt-4 hidden p-4 bg-yellow-50 text-yellow-700 rounded-lg shadow-inner flex items-center justify-center">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-yellow-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            ƒêang g·ª≠i ·∫£nh ƒë·∫øn AI... Vui l√≤ng ch·ªù v√†i gi√¢y.
        </div>
        <div id="resultMessage" class="mt-4 p-4 rounded-lg text-sm hidden"></div>

        <div id="dataOutput" class="mt-8 p-6 bg-gray-50 rounded-xl shadow-inner hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">3. Xem L·∫°i v√† Ch·ªânh S·ª≠a D·ªØ Li·ªáu</h2>
            <div id="editableTable" class="overflow-x-auto space-y-4">
                </div>
            
            <div class="mt-6 flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                <button id="addToListButton" class="w-full md:w-1/2 btn-continue font-bold py-3 px-4 rounded-xl shadow-lg transition duration-150 disabled:opacity-50" disabled>
                    Th√™m V√†o Danh S√°ch & Ti·∫øp T·ª•c (Quay v·ªÅ B1)
                </button>
                <button id="downloadAllButton" class="w-full md:w-1/2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-150 disabled:opacity-50" disabled>
                    4. T·∫£i V·ªÅ To√†n B·ªô Danh S√°ch CSV (<span id="downloadCount">0</span> h·ªì s∆°)
                </button>
            </div>
        </div>
        
        <div class="app-footer text-center">
            T√°c gi·∫£: **L√™ Minh Hu·∫•n** - CN VPƒêKƒêƒê 8 Qu·∫£ng Ninh - H·ªó tr·ª£ b·ªüi AI
        </div>

    </div>

    <script>
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const processButton = document.getElementById('processButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultMessage = document.getElementById('resultMessage');
        const dataOutput = document.getElementById('dataOutput');
        const editableTable = document.getElementById('editableTable');
        const statusCccd = document.getElementById('statusCccd');
        const statusGcn = document.getElementById('statusGcn');
        const uploadHint = document.getElementById('uploadHint');
        const addToListButton = document.getElementById('addToListButton');
        const downloadAllButton = document.getElementById('downloadAllButton');
        const recordCount = document.getElementById('recordCount');
        const downloadCount = document.getElementById('downloadCount');
        
        // --- TR·∫†NG TH√ÅI ·ª®NG D·ª§NG V√Ä D·ªÆ LI·ªÜU ---
        let base64Image = null; // D·ªØ li·ªáu ·∫£nh/PDF ƒë√£ chuy·ªÉn ƒë·ªïi sang Base64
        let cccdData = null; // D·ªØ li·ªáu CCCD (t·∫°m)
        let gcnData = null;  // D·ªØ li·ªáu GCN (t·∫°m)
        let currentStep = 'CCCD'; // B·∫Øt ƒë·∫ßu b·∫±ng CCCD
        let allRecords = []; // M·∫¢NG L·ªöN L∆ØU TR·ªÆ T·∫§T C·∫¢ C√ÅC H·ªí S∆† ƒê√É HO√ÄN TH√ÄNH
        
        const API_KEY = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 5;

        // --- SCHEMAS ƒê·ªäNH NGHƒ®A CHO T·ª™NG LO·∫†I T√ÄI LI·ªÜU ---
        // (CCCD SCHEMA)
        const CCCD_SCHEMA_PROPERTIES = {
            tenTaiLieu: { "type": "STRING", "description": "T√™n t√†i li·ªáu: CƒÉn c∆∞·ªõc c√¥ng d√¢n." },
            soCCCD: { "type": "STRING", "description": "S·ªë CCCD ho·∫∑c CMND." },
            hoTen: { "type": "STRING", "description": "H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß." },
            ngaySinh: { "type": "STRING", "description": "Ng√†y, th√°ng, nƒÉm sinh (DD/MM/YYYY)." },
            gioiTinh: { "type": "STRING", "description": "Gi·ªõi t√≠nh." },
            quocTich: { "type": "STRING", "description": "Qu·ªëc t·ªãch." },
            queQuan: { "type": "STRING", "description": "Qu√™ qu√°n." },
            noiThuongTru: { "type": "STRING", "description": "N∆°i th∆∞·ªùng tr√∫." },
            ngayCap: { "type": "STRING", "description": "Ng√†y c·∫•p (DD/MM/YYYY)." },
            noiCap: { "type": "STRING", "description": "N∆°i c·∫•p." }
        };

        // (GCN SCHEMA - BI·ªÇU M·∫™U S·ªê 01)
        const GCN_SCHEMA_PROPERTIES = {
            tenTaiLieu: { "type": "STRING", "description": "T√™n t√†i li·ªáu: Gi·∫•y Ch·ª©ng Nh·∫≠n Quy·ªÅn S·ª≠ D·ª•ng ƒê·∫•t (S·ªï ƒë·ªè/S·ªï h·ªìng)." },
            // TH√îNG TIN GCN
            soPhatHanhGCN: { "type": "STRING", "description": "S·ªë ph√°t h√†nh GCN (Seri)." },
            ngayCapGCN: { "type": "STRING", "description": "Ng√†y c·∫•p gi·∫•y ch·ª©ng nh·∫≠n (DD/MM/YYYY)." },
            soVaoSoGCN: { "type": "STRING", "description": "S·ªë v√†o s·ªï c·∫•p Gi·∫•y ch·ª©ng nh·∫≠n quy·ªÅn s·ª≠ d·ª•ng ƒë·∫•t." },
            // TH√îNG TIN CH·ª¶ S·ª¨ D·ª§NG (S·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn t·ª´ CCCD n·∫øu c√≥)
            hoTenChuSuDung: { "type": "STRING", "description": "H·ªç v√† t√™n ch·ªß s·ª≠ d·ª•ng." },
            ngaySinhChuSuDung: { "type": "STRING", "description": "Ng√†y, th√°ng, nƒÉm sinh ch·ªß s·ª≠ d·ª•ng (DD/MM/YYYY)." },
            gioiTinh: { "type": "STRING", "description": "Gi·ªõi t√≠nh ch·ªß s·ª≠ d·ª•ng." },
            soDinhDanhCCCD: { "type": "STRING", "description": "S·ªë ƒë·ªãnh danh c√° nh√¢n/CCCD c·ªßa ch·ªß s·ª≠ d·ª•ng." },
            diaChiThuongTru: { "type": "STRING", "description": "ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫ c·ªßa ch·ªß s·ª≠ d·ª•ng ƒë·∫•t." },
            tenToChuc: { "type": "STRING", "description": "T√™n t·ªï ch·ª©c (n·∫øu ch·ªß s·ª≠ d·ª•ng l√† t·ªï ch·ª©c). ƒê·ªÉ tr·ªëng n·∫øu l√† c√° nh√¢n." },
            // TH√îNG TIN TH·ª¨A ƒê·∫§T
            soHieuToBanDo: { "type": "STRING", "description": "S·ªë hi·ªáu t·ªù b·∫£n ƒë·ªì." },
            soThuTuThuaDat: { "type": "STRING", "description": "S·ªë th·ª© t·ª± th·ª≠a ƒë·∫•t." },
            diaChiThuaDat: { "type": "STRING", "description": "ƒê·ªãa ch·ªâ th·ª≠a ƒë·∫•t." },
            dienTichThuaDat: { "type": "STRING", "description": "Di·ªán t√≠ch th·ª≠a ƒë·∫•t (T·ªïng)." },
            // ƒêA M·ª§C ƒê√çCH 1 (C·ªôt V, W, X, Y, Z trong bi·ªÉu m·∫´u)
            mucDichSuDung1: { "type": "STRING", "description": "M·ª•c ƒë√≠ch s·ª≠ d·ª•ng ƒë·∫•t 1." },
            dienTichSuDung1: { "type": "STRING", "description": "Di·ªán t√≠ch m·ª•c ƒë√≠ch s·ª≠ d·ª•ng ƒë·∫•t 1." },
            nguonGocSuDung1: { "type": "STRING", "description": "Ngu·ªìn g·ªëc s·ª≠ d·ª•ng m·ª•c ƒë√≠ch s·ª≠ d·ª•ng ƒë·∫•t 1." },
            hinhThucSuDung1: { "type": "STRING", "description": "H√¨nh th·ª©c s·ª≠ d·ª•ng 1 (S·ª≠ d·ª•ng ri√™ng/chung)." },
            thoiHanSuDung1: { "type": "STRING", "description": "Th·ªùi h·∫°n s·ª≠ d·ª•ng 1 (L√¢u d√†i/ƒê·∫øn ng√†y...)." }
        };

        const SYSTEM_PROMPT = "B·∫°n l√† m·ªôt c√¥ng c·ª• tr√≠ch xu·∫•t d·ªØ li·ªáu ch√≠nh x√°c t·ª´ t√†i li·ªáu. H√£y tr√≠ch xu·∫•t t·∫•t c·∫£ c√°c tr∆∞·ªùng d·ªØ li·ªáu ƒë∆∞·ª£c y√™u c·∫ßu t·ª´ ·∫£nh t√†i li·ªáu ƒë∆∞·ª£c cung c·∫•p. ƒê·∫£m b·∫£o d·ªØ li·ªáu ƒë·∫ßu ra tu√¢n th·ªß ch√≠nh x√°c ƒë·ªãnh d·∫°ng JSON ƒë∆∞·ª£c cung c·∫•p.";

        // --- √ÅNH X·∫† T√äN TR∆Ø·ªúNG TI·∫æNG VI·ªÜT (D√πng cho GCN/Bi·ªÉu m·∫´u 01) ---

        const FIELD_NAMES_VN = {
            // CCCD (ch·ªâ d√πng t·∫°m trong state, kh√¥ng hi·ªÉn th·ªã tr·ª±c ti·∫øp)
            tenTaiLieu: "T√™n T√†i Li·ªáu",
            soCCCD: "S·ªë CCCD/CMND",
            hoTen: "H·ªç v√† T√™n (CCCD)",
            ngaySinh: "Ng√†y/Th√°ng/NƒÉm Sinh (CCCD)",
            
            // GCN QSDƒê (BI·ªÇU M·∫™U S·ªê 01) - ƒê√¢y l√† c√°c tr∆∞·ªùng hi·ªÉn th·ªã v√† xu·∫•t CSV
            soPhatHanhGCN: "S·ªë ph√°t h√†nh GCN (Seri)",
            ngayCapGCN: "Ng√†y c·∫•p GCN",
            soVaoSoGCN: "S·ªë v√†o s·ªï GCN",
            hoTenChuSuDung: "H·ªç v√† t√™n ch·ªß s·ª≠ d·ª•ng",
            ngaySinhChuSuDung: "Ng√†y, th√°ng, nƒÉm sinh ch·ªß SD",
            gioiTinh: "Gi·ªõi t√≠nh ch·ªß SD",
            soDinhDanhCCCD: "S·ªë ƒë·ªãnh danh c√° nh√¢n/CCCD",
            diaChiThuongTru: "ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫",
            tenToChuc: "T√™n t·ªï ch·ª©c (N·∫øu c√≥)",
            soHieuToBanDo: "S·ªë hi·ªáu t·ªù b·∫£n ƒë·ªì",
            soThuTuThuaDat: "S·ªë th·ª© t·ª± th·ª≠a ƒë·∫•t",
            diaChiThuaDat: "ƒê·ªãa ch·ªâ th·ª≠a ƒë·∫•t",
            dienTichThuaDat: "Di·ªán t√≠ch th·ª≠a ƒë·∫•t (T·ªïng)",
            mucDichSuDung1: "M·ª•c ƒë√≠ch s·ª≠ d·ª•ng ƒë·∫•t 1",
            dienTichSuDung1: "Di·ªán t√≠ch m·ª•c ƒë√≠ch SD 1",
            nguonGocSuDung1: "Ngu·ªìn g·ªëc s·ª≠ d·ª•ng m·ª•c ƒë√≠ch SD 1",
            hinhThucSuDung1: "H√¨nh th·ª©c s·ª≠ d·ª•ng 1",
            thoiHanSuDung1: "Th·ªùi h·∫°n s·ª≠ d·ª•ng 1"
        };

        // --- H√ÄM C·∫¨P NH·∫¨T GIAO DI·ªÜN B∆Ø·ªöC QUY TR√åNH ---
        function updateProcessUI() {
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i CCCD
            if (cccdData) {
                statusCccd.innerHTML = 'B∆∞·ªõc 1: Qu√©t CCCD/CMND - <span class="text-green-600 font-bold">HO√ÄN TH√ÄNH</span>';
                statusGcn.classList.remove('text-gray-400');
                statusGcn.classList.add('text-gray-900');
            } else {
                statusCccd.innerHTML = 'B∆∞·ªõc 1: Qu√©t CCCD/CMND - <span class="text-red-500 font-medium">Ch∆∞a ho√†n th√†nh</span>';
                statusGcn.classList.add('text-gray-400');
                statusGcn.classList.remove('text-gray-900');
            }

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i GCN
            if (gcnData) {
                statusGcn.innerHTML = 'B∆∞·ªõc 2: Qu√©t GCN QSDƒê - <span class="text-green-600 font-bold">HO√ÄN TH√ÄNH</span>';
            } else {
                statusGcn.innerHTML = 'B∆∞·ªõc 2: Qu√©t GCN QSDƒê - <span class="text-red-500 font-medium">Ch∆∞a ho√†n th√†nh</span>';
            }

            // C·∫≠p nh·∫≠t n√∫t x·ª≠ l√Ω ch√≠nh v√† G·ª£i √Ω t·∫£i ·∫£nh
            if (cccdData && gcnData) {
                processButton.textContent = "2. (HO√ÄN T·∫§T) Xem L·∫°i Bi·ªÉu M·∫´u ƒê√£ Gh√©p";
                processButton.classList.remove('bg-indigo-600');
                processButton.classList.add('bg-blue-600');
                uploadHint.innerHTML = 'üéâ Quy tr√¨nh ho√†n t·∫•t! Vui l√≤ng ki·ªÉm tra M·ª•c 3.';
                // T·ª± ƒë·ªông hi·ªÉn th·ªã k·∫øt qu·∫£ sau khi GCN xong
                mergeAndDisplayData(); 
            } else if (cccdData) {
                currentStep = 'GCN';
                processButton.textContent = "2. (B∆∞·ªõc 2) B·∫Øt ƒë·∫ßu Qu√©t GCN QSDƒê";
                processButton.classList.remove('bg-blue-600');
                processButton.classList.add('bg-indigo-600');
                uploadHint.innerHTML = '‚úÖ B∆∞·ªõc 1 ho√†n t·∫•t. Vui l√≤ng t·∫£i l√™n ·∫£nh **Gi·∫•y ch·ª©ng nh·∫≠n QSDƒê** ho·∫∑c **file PDF** cho B∆∞·ªõc 2.';
            } else {
                currentStep = 'CCCD';
                processButton.textContent = "2. (B∆∞·ªõc 1) B·∫Øt ƒë·∫ßu Qu√©t CCCD/CMND";
                processButton.classList.remove('bg-blue-600');
                processButton.classList.add('bg-indigo-600');
                uploadHint.innerHTML = '*L∆∞u √Ω: Vui l√≤ng t·∫£i l√™n file ·∫£nh (.jpg, .png) ho·∫∑c **file PDF** ch·ª©a **hai m·∫∑t** c·ªßa CCCD/CMND cho B∆∞·ªõc 1.';
            }

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t t·∫£i v·ªÅ t·ªïng h·ª£p
            downloadCount.textContent = allRecords.length;
            recordCount.textContent = `ƒê√£ nh·∫≠p: ${allRecords.length} h·ªì s∆°`;
            downloadAllButton.disabled = allRecords.length === 0;
        }
        
        // --- CH·ª®C NƒÇNG L·∫§Y SCHEMA V√Ä PROMPT HI·ªÜN T·∫†I ---
        function getCurrentSchemaAndPrompt() {
            if (currentStep === 'CCCD') {
                return {
                    schema: { type: "OBJECT", properties: CCCD_SCHEMA_PROPERTIES, required: ["soCCCD", "hoTen", "ngaySinh"] },
                    prompt: "Tr√≠ch xu·∫•t t·∫•t c·∫£ th√¥ng tin c∆° b·∫£n tr√™n CƒÉn c∆∞·ªõc c√¥ng d√¢n n√†y. ·∫¢nh n√†y c√≥ th·ªÉ ch·ª©a c·∫£ m·∫∑t tr∆∞·ªõc v√† m·∫∑t sau.",
                    mimeType: "image/jpeg"
                };
            } else if (currentStep === 'GCN') {
                return {
                    schema: { type: "OBJECT", properties: GCN_SCHEMA_PROPERTIES, required: ["soPhatHanhGCN", "hoTenChuSuDung"] },
                    prompt: "Tr√≠ch xu·∫•t th√¥ng tin chi ti·∫øt v·ªÅ GCN QSDƒê, bao g·ªìm s·ªë seri, ng√†y c·∫•p, s·ªë t·ªù, s·ªë th·ª≠a, di·ªán t√≠ch v√† chi ti·∫øt M·ª•c ƒë√≠ch s·ª≠ d·ª•ng ƒë·∫•t 1.",
                    mimeType: "image/jpeg"
                };
            }
            return null;
        }

        // --- H√ÄM X·ª¨ L√ù FILE PDF TH√ÄNH ·∫¢NH BASE64 (ƒê√É CH·ªàNH S·ª¨A) ---
        async function renderPdfToImage(file) {
            const pdfjsLib = window['pdfjs-dist/build/pdf'];
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.js';

            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onload = async function(event) {
                    try {
                        const pdfData = new Uint8Array(event.target.result);
                        const loadingTask = pdfjsLib.getDocument({ data: pdfData });
                        const pdf = await loadingTask.promise;
                        
                        const scale = 2.0;
                        const canvasList = [];
                        let totalHeight = 0;
                        let maxWidth = 0;

                        // Render t·ª´ng trang
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: scale });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            const renderContext = {
                                canvasContext: context,
                                viewport: viewport
                            };

                            await page.render(renderContext).promise;
                            canvasList.push(canvas);
                            totalHeight += viewport.height;
                            if (viewport.width > maxWidth) {
                                maxWidth = viewport.width;
                            }
                        }

                        // Gh√©p c√°c canvas l·∫°i th√†nh m·ªôt canvas duy nh·∫•t
                        const combinedCanvas = document.createElement('canvas');
                        const combinedContext = combinedCanvas.getContext('2d');
                        combinedCanvas.width = maxWidth;
                        combinedCanvas.height = totalHeight;

                        let yOffset = 0;
                        for (const canvas of canvasList) {
                            combinedContext.drawImage(canvas, 0, yOffset);
                            yOffset += canvas.height;
                        }
                        
                        // Chuy·ªÉn canvas ƒë√£ gh√©p th√†nh JPEG Base64 data
                        const dataUrl = combinedCanvas.toDataURL('image/jpeg', 0.9);
                        resolve(dataUrl.split(',')[1]);

                    } catch (e) {
                        console.error("PDF rendering error:", e);
                        reject("Kh√¥ng th·ªÉ x·ª≠ l√Ω file PDF. Vui l√≤ng ƒë·∫£m b·∫£o file kh√¥ng b·ªã m√£ h√≥a.");
                    }
                };
                reader.onerror = (e) => reject(`L·ªói ƒë·ªçc file: ${e.message}`);
                reader.readAsArrayBuffer(file);
            });
        }


        // --- X·ª¨ L√ù T·∫¢I FILE (IMAGE/PDF) V√Ä BASE64 ---
        imageUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) {
                imagePreview.style.display = 'none';
                processButton.disabled = true;
                base64Image = null;
                return;
            }
            
            // X√≥a th√¥ng b√°o c≈©
            resultMessage.classList.add('hidden');
            
            // X·ª≠ l√Ω file
            if (file.type === 'application/pdf') {
                // X·ª≠ l√Ω PDF
                processButton.disabled = true;
                loadingIndicator.classList.remove('hidden');
                imagePreview.style.display = 'none'; // Kh√¥ng th·ªÉ xem tr∆∞·ªõc PDF tr·ª±c ti·∫øp
                resultMessage.textContent = "ƒêang x·ª≠ l√Ω file PDF (Gh√©p t·∫•t c·∫£ c√°c trang)...";
                resultMessage.className = "mt-4 p-4 bg-yellow-100 text-yellow-700 rounded-lg shadow-inner";
                resultMessage.classList.remove('hidden');

                try {
                    base64Image = await renderPdfToImage(file);
                    
                    // G√°n placeholder cho ·∫£nh xem tr∆∞·ªõc
                    imagePreview.src = 'https://placehold.co/150x200/4f46e5/ffffff?text=PDF+Loaded';
                    imagePreview.style.display = 'block';
                    
                    processButton.disabled = false;
                    resultMessage.classList.add('hidden');

                } catch (error) {
                    console.error(error);
                    resultMessage.textContent = `‚ùå L·ªói x·ª≠ l√Ω file PDF: ${error.message || error}`;
                    resultMessage.className = "mt-4 p-4 bg-red-100 text-red-700 rounded-lg shadow-inner";
                    resultMessage.classList.remove('hidden');
                    processButton.disabled = true;
                } finally {
                    loadingIndicator.classList.add('hidden');
                }

            } else if (file.type.startsWith('image/')) {
                // X·ª≠ l√Ω Image
                const reader = new FileReader();
                reader.onload = (event) => {
                    base64Image = event.target.result.split(',')[1];
                    imagePreview.src = event.target.result;
                    imagePreview.style.display = 'block';
                    processButton.disabled = false;
                };
                reader.readAsDataURL(file);
            } else {
                // Lo·∫°i file kh√¥ng h·ªó tr·ª£
                resultMessage.textContent = "‚ùå Lo·∫°i file kh√¥ng h·ªó tr·ª£. Vui l√≤ng ch·ªçn ·∫£nh (.jpg, .png) ho·∫∑c file PDF.";
                resultMessage.className = "mt-4 p-4 bg-red-100 text-red-700 rounded-lg shadow-inner";
                resultMessage.classList.remove('hidden');
                processButton.disabled = true;
            }
        });
        
        // --- LOGIC G·ªåI API V√Ä L∆ØU TR·ªÆ D·ªÆ LI·ªÜU ---
        async function callGeminiAPI(retries = 0) {
            if (!base64Image) {
                resultMessage.textContent = "‚ùå Vui l√≤ng t·∫£i ·∫£nh/PDF l√™n tr∆∞·ªõc khi qu√©t.";
                resultMessage.className = "mt-4 p-4 bg-red-100 text-red-700 rounded-lg shadow-inner";
                resultMessage.classList.remove('hidden');
                return;
            }

            const current = getCurrentSchemaAndPrompt();
            if (!current) return;

            loadingIndicator.classList.remove('hidden');
            resultMessage.classList.add('hidden');
            processButton.disabled = true;
            dataOutput.classList.add('hidden');

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: current.prompt },
                            {
                                inlineData: {
                                    mimeType: current.mimeType, 
                                    data: base64Image
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: SYSTEM_PROMPT }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: current.schema
                }
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429 && retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callGeminiAPI(retries + 1);
                }

                if (!response.ok) {
                    throw new Error(`L·ªói HTTP: ${response.status} - ${response.statusText}`);
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) {
                    throw new Error("API kh√¥ng tr·∫£ v·ªÅ d·ªØ li·ªáu JSON h·ª£p l·ªá.");
                }

                const extractedData = JSON.parse(jsonText);
                
                // L∆ØU D·ªÆ LI·ªÜU V√Ä CHUY·ªÇN B∆Ø·ªöC
                if (currentStep === 'CCCD') {
                    cccdData = extractedData;
                    currentStep = 'GCN';
                    
                    resultMessage.textContent = "‚úÖ Qu√©t CCCD th√†nh c√¥ng! Vui l√≤ng T·∫¢I ·∫¢NH/PDF GCN L√äN v√† nh·∫•n n√∫t ƒë·ªÉ sang B∆∞·ªõc 2.";
                    resultMessage.className = "mt-4 p-4 bg-green-100 text-green-700 rounded-lg shadow-inner";
                    imageUpload.value = ''; // X√≥a file ƒë√£ t·∫£i ƒë·ªÉ y√™u c·∫ßu t·∫£i ·∫£nh m·ªõi
                    imagePreview.style.display = 'none';
                    base64Image = null;
                } else if (currentStep === 'GCN') {
                    gcnData = extractedData;
                    // T·ª± ƒë·ªông hi·ªÉn th·ªã k·∫øt qu·∫£ sau khi GCN ho√†n t·∫•t
                    mergeAndDisplayData();
                }
                
            } catch (error) {
                console.error("L·ªói tr√≠ch xu·∫•t d·ªØ li·ªáu:", error);
                resultMessage.textContent = `‚ùå L·ªói: Kh√¥ng th·ªÉ tr√≠ch xu·∫•t d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ƒë·∫£m b·∫£o ·∫£nh/PDF r√µ n√©t. Chi ti·∫øt: ${error.message}`;
                resultMessage.className = "mt-4 p-4 bg-red-100 text-red-700 rounded-lg shadow-inner";
            } finally {
                loadingIndicator.classList.add('hidden');
                processButton.disabled = false;
                updateProcessUI();
            }
        }

        // --- H√ÄM GH√âP D·ªÆ LI·ªÜU V√Ä HI·ªÇN TH·ªä CU·ªêI C√ôNG ---
        function mergeAndDisplayData() {
            if (!cccdData || !gcnData) {
                resultMessage.textContent = "‚ö†Ô∏è C·∫ßn qu√©t c·∫£ CCCD v√† GCN ƒë·ªÉ t·∫°o bi·ªÉu m·∫´u ho√†n ch·ªânh.";
                resultMessage.className = "mt-4 p-4 bg-red-100 text-red-700 rounded-lg shadow-inner";
                resultMessage.classList.remove('hidden');
                return {};
            }

            // 1. Sao ch√©p d·ªØ li·ªáu GCN l√†m c∆° s·ªü
            const finalData = { ...gcnData };

            // 2. ∆ØU TI√äN D·ªÆ LI·ªÜU C√Å NH√ÇN T·ª™ CCCD
            finalData.hoTenChuSuDung = cccdData.hoTen || finalData.hoTenChuSuDung;
            finalData.ngaySinhChuSuDung = cccdData.ngaySinh || finalData.ngaySinhChuSuDung;
            finalData.gioiTinh = cccdData.gioiTinh || finalData.gioiTinh;
            finalData.soDinhDanhCCCD = cccdData.soCCCD || finalData.soDinhDanhCCCD;
            finalData.diaChiThuongTru = cccdData.noiThuongTru || finalData.diaChiThuongTru;

            // 3. Hi·ªÉn th·ªã d·ªØ li·ªáu ƒë√£ gh√©p
            displayEditableData(finalData);
            
            // K√≠ch ho·∫°t n√∫t Th√™m v√†o danh s√°ch
            addToListButton.disabled = false;

            resultMessage.textContent = "‚úÖ Gh√©p d·ªØ li·ªáu th√†nh c√¥ng! Vui l√≤ng ki·ªÉm tra v√† ch·ªânh s·ª≠a tr∆∞·ªõc khi Th√™m v√†o danh s√°ch.";
            resultMessage.className = "mt-4 p-4 bg-green-100 text-green-700 rounded-lg shadow-inner";
            resultMessage.classList.remove('hidden');
        }

        // --- H√ÄM HI·ªÇN TH·ªä D·ªÆ LI·ªÜU C√ì TH·ªÇ CH·ªàNH S·ª¨A ---
        function displayEditableData(data) {
            dataOutput.classList.remove('hidden');
            editableTable.innerHTML = '';
            
            let html = '';
            
            // S·∫Øp x·∫øp l·∫°i keys theo th·ª© t·ª± logic c·ªßa Bi·ªÉu 01 ƒë·ªÉ d·ªÖ ki·ªÉm tra
            const orderKeys = [
                'soPhatHanhGCN', 'ngayCapGCN', 'soVaoSoGCN', 
                'hoTenChuSuDung', 'ngaySinhChuSuDung', 'gioiTinh', 'soDinhDanhCCCD', 'diaChiThuongTru', 'tenToChuc',
                'soHieuToBanDo', 'soThuTuThuaDat', 'diaChiThuaDat', 'dienTichThuaDat',
                'mucDichSuDung1', 'dienTichSuDung1', 'nguonGocSuDung1', 'hinhThucSuDung1', 'thoiHanSuDung1'
            ];

            orderKeys.forEach(key => {
                if (FIELD_NAMES_VN.hasOwnProperty(key)) {
                    const label = FIELD_NAMES_VN[key];
                    const value = data[key] || "";
                    
                    // Th√™m class ƒë·∫∑c bi·ªát ƒë·ªÉ l√†m n·ªïi b·∫≠t c√°c tr∆∞·ªùng l·∫•y t·ª´ CCCD
                    const highlightClass = (key === 'hoTenChuSuDung' || key === 'ngaySinhChuSuDung' || key === 'soDinhDanhCCCD' || key === 'diaChiThuongTru' || key === 'gioiTinh') ? 'border-2 border-indigo-500 bg-indigo-50' : '';

                    html += `
                        <div class="flex flex-col sm:flex-row items-start sm:items-center py-2 border-b border-gray-200">
                            <label for="${key}" class="w-full sm:w-1/3 text-sm font-medium text-gray-900 mb-1 sm:mb-0">${label}</label>
                            <input type="text" id="${key}" value="${value}" 
                                class="data-input w-full sm:w-2/3 p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm ${highlightClass}"
                                data-key="${key}" placeholder="Kh√¥ng t√¨m th·∫•y/Vui l√≤ng nh·∫≠p">
                        </div>
                    `;
                }
            });
            
            editableTable.innerHTML = html;
        }

        // --- H√ÄM L·∫§Y D·ªÆ LI·ªÜU ƒê√É CH·ªàNH S·ª¨A ---
        function getEditedData() {
            const inputs = editableTable.querySelectorAll('.data-input');
            const editedData = {};
            
            inputs.forEach(input => {
                const key = input.getAttribute('data-key');
                editedData[key] = input.value;
            });
            
            return editedData;
        }
        
        // --- H√ÄM TH√äM V√ÄO DANH S√ÅCH & RESET ---
        function addRecordAndReset() {
            const finalRecord = getEditedData();
            
            // Th√™m b·∫£n ghi ƒë√£ ch·ªânh s·ª≠a v√†o m·∫£ng t·ªïng h·ª£p
            allRecords.push(finalRecord);

            // 1. Reset tr·∫°ng th√°i t·∫°m th·ªùi
            cccdData = null;
            gcnData = null;
            base64Image = null;
            
            // 2. Reset UI v·ªÅ B∆∞·ªõc 1
            imageUpload.value = '';
            imagePreview.style.display = 'none';
            dataOutput.classList.add('hidden');
            addToListButton.disabled = true;
            editableTable.innerHTML = '';
            
            // 3. Th√¥ng b√°o v√† c·∫≠p nh·∫≠t UI
            resultMessage.textContent = `‚úÖ ƒê√£ th√™m h·ªì s∆° th·ª© ${allRecords.length} v√†o danh s√°ch. Ti·∫øp t·ª•c t·∫£i ·∫£nh CCCD/PDF m·ªõi ƒë·ªÉ nh·∫≠p h·ªì s∆° ti·∫øp theo.`;
            resultMessage.className = "mt-4 p-4 bg-green-100 text-green-700 rounded-lg shadow-inner";
            resultMessage.classList.remove('hidden');

            updateProcessUI();
        }

        // --- H√ÄM T·∫†O CSV T·ª™ DANH S√ÅCH L·ªöN ---
        function convertToCSV(records) {
            if (!records || records.length === 0) return '';
            
            // ƒê·ªãnh nghƒ©a th·ª© t·ª± Header d·ª±a tr√™n Bi·ªÉu m·∫´u 01
            const orderKeys = [
                'soPhatHanhGCN', 'ngayCapGCN', 'soVaoSoGCN', 
                'hoTenChuSuDung', 'ngaySinhChuSuDung', 'gioiTinh', 'soDinhDanhCCCD', 'diaChiThuongTru', 'tenToChuc',
                'soHieuToBanDo', 'soThuTuThuaDat', 'diaChiThuaDat', 'dienTichThuaDat',
                'mucDichSuDung1', 'dienTichSuDung1', 'nguonGocSuDung1', 'hinhThucSuDung1', 'thoiHanSuDung1'
            ];
            
            // T·∫°o Header (ti·∫øng Vi·ªát)
            const headersVN = orderKeys.map(key => FIELD_NAMES_VN[key] || key);
            let csv = headersVN.join(',') + '\n';
            
            // Th√™m t·ª´ng h√†ng d·ªØ li·ªáu
            records.forEach(record => {
                const rowData = orderKeys.map(key => {
                    let value = record[key] || '';
                    if (typeof value === 'string') {
                        value = value.replace(/"/g, '""'); // Escape d·∫•u ngo·∫∑c k√©p
                        if (value.includes(',')) {
                            value = `"${value}"`; // B·ªçc chu·ªói c√≥ d·∫•u ph·∫©y
                        }
                    }
                    return value;
                });
                csv += rowData.join(',') + '\n';
            });

            return csv;
        }

        function downloadAllRecordsCSV() {
            if (allRecords.length === 0) {
                alert("Danh s√°ch tr·ªëng. Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt h·ªì s∆°.");
                return;
            }

            const csvContent = convertToCSV(allRecords);

            const docName = "Bieu_Mau_01_Tong_Hop";

            const blob = new Blob(["\ufeff", csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            // T·∫°o link download ·∫£o
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `${docName}_${Date.now()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            resultMessage.textContent = `üéâ ƒê√£ t·∫£i v·ªÅ file CSV t·ªïng h·ª£p (${allRecords.length} h·ªì s∆°)!`;
            resultMessage.className = "mt-4 p-4 bg-green-100 text-green-700 rounded-lg shadow-inner";
        }

        // --- ƒêƒÇNG K√ù EVENTS ---
        processButton.addEventListener('click', callGeminiAPI);
        addToListButton.addEventListener('click', addRecordAndReset);
        downloadAllButton.addEventListener('click', downloadAllRecordsCSV);
        
        // Kh·ªüi t·∫°o UI ban ƒë·∫ßu
        updateProcessUI();
    </script>
</body>
</html>
